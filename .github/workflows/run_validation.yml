name: Validate Rule Contributions

on:
  pull_request:
    paths:
      - 'rules/**'
    types: [opened, synchronize, reopened]

jobs:
  validate-rules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Initialize engine submodule
        run: |
          git submodule update --init --recursive
          cd engine
          SUBMODULE_COMMIT=$(git rev-parse HEAD)
          echo "Using engine submodule at commit: $SUBMODULE_COMMIT"
      
      - name: Install engine dependencies
        run: |
          cd engine
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Detect changed rules
        id: changed-rules
        run: |
          # Get list of changed rule directories
          CHANGED_RULES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^rules/CG' | cut -d'/' -f2 | sort -u)
          
          if [ -z "$CHANGED_RULES" ]; then
            echo "No rule changes detected"
            echo "rules=" >> $GITHUB_OUTPUT
          else
            echo "Changed rules: $CHANGED_RULES"
            # Convert to JSON array
            RULES_JSON=$(echo "$CHANGED_RULES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "rules=$RULES_JSON" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate changed rules
        if: steps.changed-rules.outputs.rules != ''
        run: |
          set -e
          
          RULES='${{ steps.changed-rules.outputs.rules }}'
          
          echo "$RULES" | jq -r '.[]' | while read -r RULE_ID; do
            echo ""
            echo "Validating $RULE_ID"

            YML_COUNT=$(find "rules/$RULE_ID" -maxdepth 1 -name "*.yml" | wc -l)
            if [ "$YML_COUNT" -eq 0 ]; then
              echo "ERROR: No YAML file found in rules/$RULE_ID/"
              exit 1
            fi
            
            # Backup committed results before generating new ones
            echo ""
            echo "Backing up committed results..."
            for TEST_TYPE in positive negative; do
              TEST_PATH="rules/$RULE_ID/$TEST_TYPE"
              if [ -d "$TEST_PATH" ]; then
                for CASE_DIR in "$TEST_PATH"/*; do
                  if [ -d "$CASE_DIR" ] && [ -f "$CASE_DIR/results/results.json" ]; then
                    cp "$CASE_DIR/results/results.json" "$CASE_DIR/results/results.json.committed"
                    echo "  Backed up: $CASE_DIR/results/results.json"
                  fi
                done
              fi
            done
            
            # Generate fresh results (overwrites results.json)
            echo ""
            echo "Generating fresh results..."
            python test.py generate_rule_results "$RULE_ID"
            
            if [ $? -ne 0 ]; then
              echo "ERROR: Failed to generate results for $RULE_ID"
              exit 1
            fi
            
            # Compare backup (committed) vs fresh (generated)
            echo ""
            echo "Comparing generated vs committed results..."
            
            RULE_PASSED=true
            
            for TEST_TYPE in positive negative; do
              TEST_PATH="rules/$RULE_ID/$TEST_TYPE"
              
              if [ ! -d "$TEST_PATH" ]; then
                continue
              fi
              
              for CASE_DIR in "$TEST_PATH"/*; do
                if [ ! -d "$CASE_DIR" ]; then
                  continue
                fi
                
                CASE_ID=$(basename "$CASE_DIR")
                COMMITTED_RESULTS="$CASE_DIR/results/results.json.committed"
                GENERATED_RESULTS="$CASE_DIR/results/results.json"
                
                if [ ! -f "$COMMITTED_RESULTS" ]; then
                  echo "  $TEST_TYPE/$CASE_ID: No committed results found"
                  continue
                fi
                
                if [ ! -f "$GENERATED_RESULTS" ]; then
                  echo "  $TEST_TYPE/$CASE_ID: Failed to generate results"
                  RULE_PASSED=false
                  continue
                fi
                
                # Compare with Python
                python -c "
                import json
                import sys

                with open('$COMMITTED_RESULTS') as f:
                    committed = json.load(f)
                with open('$GENERATED_RESULTS') as f:
                    generated = json.load(f)

                committed_errors = sum(len(ds.get('errors', [])) for ds in committed.get('datasets', []))
                generated_errors = sum(len(ds.get('errors', [])) for ds in generated.get('datasets', []))

                if committed_errors != generated_errors:
                    print(f'  $TEST_TYPE/$CASE_ID: Error count mismatch')
                    print(f'    Committed: {committed_errors} errors')
                    print(f'    Generated: {generated_errors} errors')
                    sys.exit(1)

                # Validate expectations
                if '$TEST_TYPE' == 'positive':
                    if generated_errors == 0:
                        print(f'  $TEST_TYPE/$CASE_ID: 0 errors (valid positive test)')
                    else:
                        print(f'  $TEST_TYPE/$CASE_ID: {generated_errors} errors (should be 0)')
                        sys.exit(1)
                else:
                    if generated_errors > 0:
                        print(f'  $TEST_TYPE/$CASE_ID: {generated_errors} errors (valid negative test)')
                    else:
                        print(f'  $TEST_TYPE/$CASE_ID: 0 errors (should be >0)')
                        sys.exit(1)
                "
                if [ $? -ne 0 ]; then
                  RULE_PASSED=false
                fi
              done
            done
            
            if [ "$RULE_PASSED" = false ]; then
              echo ""
              echo "============================================================"
              echo "Validation failed for $RULE_ID"
              echo "The committed results.json files don't match the generated results."
              echo "============================================================"
              echo ""
              exit 1
            fi
            
            echo ""
            echo "âœ“ All validations passed for $RULE_ID"
          done
          
          echo ""
          echo "All validations passed"
          echo ""
