name: Validate Rule Contributions

on:
  pull_request:
    paths:
      - 'rules/**'
    types: [opened, synchronize, reopened]

jobs:
  validate-rules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Setup Virtual Environment
        run: python -m venv venv

      - name: Initialize engine submodule and Install Dependencies
        run: |
          VENV_PYTHON=$(pwd)/venv/bin/python
          VENV_PIP=$(pwd)/venv/bin/pip
          
          $VENV_PYTHON -m pip install --upgrade pip
          
          git submodule update --init --recursive
          
          cd engine
          $VENV_PIP install -r requirements.txt
          $VENV_PIP install -r requirements-dev.txt
          
          SUBMODULE_COMMIT=$(git rev-parse HEAD)
          echo "Using engine submodule at commit: $SUBMODULE_COMMIT"
          cd ..

      - name: Detect changed rules
        id: changed-rules
        run: |
          # Get list of changed rule directories
          CHANGED_RULES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^rules/CG' | cut -d'/' -f2 | sort -u)
          
          if [ -z "$CHANGED_RULES" ]; then
            echo "No rule changes detected"
            echo "rules=" >> $GITHUB_OUTPUT
          else
            echo "Changed rules: $CHANGED_RULES"
            # Convert to JSON array
            RULES_JSON=$(echo "$CHANGED_RULES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "rules=$RULES_JSON" >> $GITHUB_OUTPUT
          fi

      - name: Validate changed rules
        if: steps.changed-rules.outputs.rules != ''
        run: |
          set -e
          
          # Define the python path at the TOP of this step so it's easy to reuse
          PYTHON_CMD="./venv/bin/python"
          
          RULES='${{ steps.changed-rules.outputs.rules }}'
          
          echo "$RULES" | jq -r '.[]' | while read -r RULE_ID; do
            echo ""
            echo "Validating $RULE_ID"

            YML_COUNT=$(find "rules/$RULE_ID" -maxdepth 1 -name "*.yml" | wc -l)
            if [ "$YML_COUNT" -eq 0 ]; then
              echo "ERROR: No YAML file found in rules/$RULE_ID/"
              exit 1
            fi
            
            # Backup committed results
            echo ""
            echo "Backing up committed results..."
            for TEST_TYPE in positive negative; do
              TEST_PATH="rules/$RULE_ID/$TEST_TYPE"
              if [ -d "$TEST_PATH" ]; then
                for CASE_DIR in "$TEST_PATH"/*; do
                  if [ -d "$CASE_DIR" ] && [ -f "$CASE_DIR/results/results.json" ]; then
                    cp "$CASE_DIR/results/results.json" "$CASE_DIR/results/results.json.committed"
                    echo "  Backed up: $CASE_DIR/results/results.json"
                  fi
                done
              fi
            done
            
            # Generate fresh results
            echo ""
            echo "Generating fresh results..."
            
            # USE THE VARIABLE DEFINED AT THE TOP OF THIS BLOCK
            $PYTHON_CMD -c "from test import generate_rule_results; generate_rule_results('$RULE_ID')"
            
            if [ $? -ne 0 ]; then
              echo "ERROR: Failed to generate results for $RULE_ID"
              exit 1
            fi
            
            # Compare results
            echo ""
            echo "Comparing generated vs committed results..."
            
            RULE_PASSED=true
            
            for TEST_TYPE in positive negative; do
              TEST_PATH="rules/$RULE_ID/$TEST_TYPE"
              
              if [ ! -d "$TEST_PATH" ]; then
                continue
              fi
              
              for CASE_DIR in "$TEST_PATH"/*; do
                if [ ! -d "$CASE_DIR" ]; then
                  continue
                fi
                
                CASE_ID=$(basename "$CASE_DIR")
                COMMITTED_RESULTS="$CASE_DIR/results/results.json.committed"
                GENERATED_RESULTS="$CASE_DIR/results/results.json"
                
                if [ ! -f "$COMMITTED_RESULTS" ]; then
                  echo "  $TEST_TYPE/$CASE_ID: No committed results found"
                  continue
                fi
                
                if [ ! -f "$GENERATED_RESULTS" ]; then
                  echo "  $TEST_TYPE/$CASE_ID: Failed to generate results"
                  RULE_PASSED=false
                  continue
                fi
                
                # USE THE VARIABLE DEFINED AT THE TOP OF THIS BLOCK
                $PYTHON_CMD tests/validator.py "$COMMITTED_RESULTS" "$GENERATED_RESULTS" "$TEST_TYPE" "$CASE_ID"
                
                if [ $? -ne 0 ]; then
                  RULE_PASSED=false
                fi
              done
            done
            
            if [ "$RULE_PASSED" = false ]; then
              echo "Validation failed for $RULE_ID"
              exit 1
            fi
            
            echo "All validations passed for $RULE_ID"
          done

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results

      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Rule validation failed. Please check the workflow logs for details.'
            })